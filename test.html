<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>test</title>
    <style>
    *{
    	padding: 0;
    	margin: 0;
    	/*height: 100%;*/
    }
    .flex-wrapper {}
    
    .flex-page {
        height: 200px;
        margin: 10px;
        border: 2px solid silver;
    }
    .flex-page.overflow{
        position: relative;
    	z-index: 3;
        border-color: red;
        box-shadow: 0 0 4px red;
    }

    .flex-pageInner{
        overflow: hidden;
        padding:0 10px 10px;
    }
    
    .flex-question {
        position: relative;
        z-index: 0;
        margin-top: 10px;
        outline: 1px solid lime;
        background-color: white;
    }

    .flex-question.primary .flex-handle{
        display: none;
    }
    .flex-question.secondary .flex-remove{
        display: none;
    }

    .flex-content{
        min-height: 24px;
    	padding: 10px;
    }
    .flex-handle {
        position: absolute;
        right: 1px;
        bottom: 1px;
        width: 20px;
        height: 20px;
        text-align: center;
        line-height: 1;
        cursor: ns-resize;
    }
    
    .flex-handle:after {
        content: "+";
    }

    .flex-remove{
        position: absolute;
        z-index:0;
        right: 0;
        top: 0;
        width: 16px;
        height: 16px;
        background-color: lightgreen;
        cursor: pointer;
        text-align: center;
        line-height: 0;
    }

    .flex-remove:before,.flex-remove:after{
        content: "";
        display: inline-block;
        height:80%;
        border-left: 2px solid darkgreen;
        vertical-align: top;
    }

    .flex-remove:before{
        transform: rotate(-45deg);
    }

    .flex-remove:after{
        margin-left: -2px;
        transform: rotate(45deg);
    }
    </style>
</head>

<body ondragstart="return false;" ondragover="return false;" ondrop="return false;">
<div class="flex-wrapper">
    <div class="flex-page">
        <div class="flex-pageInner">
            <div class="flex-question">
                <div class="flex-content">asdfadfafdasfda</div>
                <div class="flex-remove"></div>
                <div class="flex-handle"></div>
            </div>
            <div class="flex-question">
                <div class="flex-content">阿发大厦的发发的发发的发阿萨德法师打发阿发大厦的发发的发发的发阿萨德法师打发阿发大厦的发发的发发的发阿萨德法师打发阿发大厦的发发的发发的发阿萨德法师打发阿发大厦的发发的发发的发阿萨德法师打发</div>
                <div class="flex-remove"></div>
                <div class="flex-handle"></div>
            </div>
            <h3>title</h3>
            <h3>title</h3>
        </div>
    </div>
    <div class="flex-page">
        <div class="flex-pageInner">
            <div class="flex-question">
                <div class="flex-content">asdfadfafdasfda</div>
                <div class="flex-remove"></div>
                <div class="flex-handle"></div>
            </div>
            <h3>title</h3>
            <h3>title</h3>
            <div class="flex-question">
                <div class="flex-content">阿发大厦的发发的发发的发阿萨德法师打发阿发大厦的发发的发发的发阿萨德法师打发阿发大厦的发发的发发的发阿萨德法师打发阿发大厦的发发的发发的发阿萨德法师打发阿发大厦的发发的发发的发阿萨德法师打发</div>
                <div class="flex-remove"></div>
                <div class="flex-handle"></div>
            </div>
        </div>
    </div>
</div>
<script type="text/template" id="tpl-question">
	<div class="flex-question secondary">
		<div class="flex-content"></div>
		<div class="flex-handle"></div>
	</div>
</script>
<script src="jquery/jquery.js"></script>
<script>
(function() {
    var S = {
        wrapper: '.flex-wrapper',
        page: '.flex-page',
        pageInner: '.flex-pageInner',
        question: '.flex-question',
        content: '.flex-content',
        remove: '.flex-remove',
        handle: '.flex-handle'
    }; // 选择器

    var activeQue = null; // 当前拖拽的元素
    var strPage = '<div class="' + S.page.substr(1) + '"><div class="' + S.pageInner.substr(1) + '"></div></div>';

    // 移除操作
    $(document).on('click', S.remove, function(e) {
        var page = $(this).parents(S.page);
        var que = $(this).parents(S.question);
        if (que.hasClass('primary')) {
            page.next().find(S.pageInner).children().first().remove();
        };
        que.remove();
        shrink(page);
    });

    // 伸缩-mousedown
    $(document).on('mousedown', S.handle, function(e) {
        activeQue = $(this).parents(S.question);
        activeQue.data('startH', activeQue.height());
        activeQue.data('startY', e.pageY);
    });

    // 伸缩-mousemove
    $(document).on('mousemove', function(e) {

        if (!activeQue) return;

    	e.preventDefault();

    	var page = activeQue.parents(S.page);
        var offsetY = e.pageY -activeQue .data('startY');
        var h = activeQue.data('startH') + offsetY;

        if (offsetY > 0 || activeQue.innerHeight() >= activeQue[0].scrollHeight) {
	        activeQue.height(h);
	        if (page.innerHeight() < page[0].scrollHeight) {
	        	page.addClass('overflow');
	        } else {
	        	page.removeClass('overflow');
	        };
        } else if (activeQue.hasClass('secondary')) {
            activeQue.height(h);
        }

        activeQue.data('offsetY', offsetY);
    });

    // 伸缩-mouseup
    $(document).on('mouseup', function(e) {

    	if (!activeQue) return;

    	var page = activeQue.parents(S.page); // 当前page
        var overflowH = page.find(S.pageInner).outerHeight(true) - page.innerHeight(); // 超出高度
        var offsetY = activeQue.data('offsetY');
        var pageNext; // 下一个page

    	if (activeQue.innerHeight() < activeQue[0].scrollHeight) { // 高度小于内容高度
            if (activeQue.hasClass('secondary')) { // 为副编辑区域
                if (activeQue.data('startH') + offsetY <= 0) { // 高度小于或等于0时，将副编辑区域合并到主编辑区域
                    if (!activeQue.find('.content').html()) { // 副编辑区域内容为空时，直接删除
                        page.prev().find(S.question + '.primary').removeClass('primary');
                        // shrink(page);
                        activeQue.remove();
                    }
                } else { // 高度大于0并且小于最小高度时，设为最小高度
                    activeQue.height(activeQue[0].scrollHeight > 44 ? activeQue[0].scrollHeight : 44);
                };
            } else { // 不为副本
        		activeQue.height(activeQue[0].scrollHeight);
            };
    	};

    	if (page.hasClass('overflow')) { // page内容溢出
            extend(page);
    	};

        if (offsetY < 0) {
            shrink(page);
        };

    	page.removeClass('overflow');
        activeQue.removeData('startH startY offsetY');
    	activeQue = null;
    });

    /**
     * 分割
     * @param  {Object} question   需要分割的question，为jquery对象
     * @param  {Number} primaryH   主编辑区域的高度
     * @param  {Number} secondaryH 副编辑区域的高度
     */
    function separate(question, primaryH, secondaryH) {

        if (question.hasClass('secondary')) { // 为副编辑区域时，不进行分割操作
            question.height(primaryH);
            return;
        };

        var page = question.parents(S.page);
        var pageNext;
        var queSecondary = $($('#tpl-question').html());

        pageNext = page.next().length ? page.next() : $(strPage).appendTo($(S.wrapper));
        queSecondary.prependTo(pageNext.find(S.pageInner)).height(function() {
            var _inner = pageNext.find(S.pageInner);
            var _maxH = pageNext.innerHeight() - (_inner.outerHeight(true) - _inner.height()) - (queSecondary.outerHeight(true) - queSecondary.height());
            if (secondaryH > _maxH) {
                return _maxH;
            } else if (secondaryH > 44) {
                return secondaryH;
            } else {
                return 44;
            };
        });
        question.height(primaryH);
        question.addClass('primary');
    };

    function merge(que_primary, que_secondary) {
        que_primary.height(que_primary.height() + que_secondary.outerHeight(true));
        que_primary.removeClass('primary');
        que_secondary.remove();
    };

    function mergeOnPage(page) {
        var que_primary = page.find(S.pageInner).children('.primary');
        var que_secondary = que_primary.next('.secondary');
        if (que_secondary.size()) {
            merge(que_primary, que_secondary);
        };
    }

    function reallocate(que_primary, height) {
        var que_secondary = que_primary.parents(S.page).next().find('.secondary').first();
        var p_h = que_primary.height();
        var s_h = que_secondary.height() + p_h - height;
        que_primary.height(height);
        if (s_h > 44) {
            que_secondary.height(s_h);
        } else {
            que_primary.removeClass('primary');
            que_secondary.remove();
        };
    };

    // 延展
    function extend(startPage) {

        var pages = startPage.add(startPage.nextAll(S.page));

        pages.each(function(i) {

            console.log(i);
            var lastChild, // 当前pageInner的最后一个子元素
                pageNext, // 下一个page
                overflowH, // 当前page内容超出的高度值
                extraH; // question多余空间高度

            var j = 0; // 防止意外情况出现死循环

            mergeOnPage($(this));

            while ($(this).innerHeight() < this.scrollHeight) {

                lastChild = $(this).find(S.pageInner).children().last();
                overflowH = this.scrollHeight - $(this).innerHeight();
                extraH = lastChild.innerHeight() - lastChild.find(S.content).outerHeight(true);

                if (lastChild.hasClass(S.question.substr(1)) && overflowH <= extraH) { // question元素且存在空白高度，且去掉空白后能够保证page内容不溢出
                    if (lastChild.hasClass('primary')) {
                        reallocate(lastChild, lastChild.height() - overflowH);
                    } else {
                        separate(lastChild, lastChild.height() - overflowH, overflowH);
                    };
                } else {
                    if ($(this).next().size()) {
                        pageNext = $(this).next();
                    } else {
                        pageNext = $(strPage).appendTo($(S.wrapper));
                        pages[pages.length] = pageNext[0];
                        pages.length++;
                        console.log(pages);
                    };
                    lastChild.prependTo(pageNext.find(S.pageInner)); // 从当前pageInner移到到下一个pageInner中
                };

                j++;
                if (j == 20) break;
            };

        });
    };

    // 收缩
    function shrink(startPage) {

        startPage.add(startPage.nextAll(S.page)).each(function(i, item, arr) {

            var lastChild, // 当前pageInner的最后一个带有primary的子元素
                firstChild, // 下一个page中pageInner第一个子元素
                overflowH, // 当前page空白高度
                extraH; // firstChild空白高度（若为question元素）

            var j = 0; // 防止意外情况出现死循环

            mergeOnPage($(this));

            while ($(this).innerHeight() > $(this).find(S.pageInner).outerHeight(true)) { // page存在空白高度

                firstChild = $(this).next().find(S.pageInner).children().first();
                overflowH = $(this).innerHeight() - $(this).find(S.pageInner).outerHeight(true);

                if (!firstChild.size()) break;

                if (firstChild.hasClass(S.question.substr(1))) { // 为question元素时
                    extraH = firstChild.innerHeight() - firstChild.find(S.content).outerHeight(true);
                    if (firstChild.hasClass('secondary')) { // 为副编辑区域
                        lastChild = $(this).find(S.pageInner).children().last();
                        if (firstChild.outerHeight(true) <= overflowH) { // 副编辑区域高度小于或等于当前page的空白高度时，合并到主编辑区域
                            merge(lastChild, firstChild);
                        } else { // 副编辑区域高度大于当前page的空白高度时，重新分配主编辑区域和副编辑区域高度
                            reallocate(lastChild, lastChild.height() + overflowH);
                        };
                    } else if (firstChild.outerHeight(true) > overflowH) { // 不为副编辑区域且firstChild高度大于当前page的空白高度
                        if (firstChild.outerHeight(true) - extraH > overflowH) { // firstChild减去空白高度后依然大于当前page的空白高度时，直接中断
                            break;
                        } else { // firstChild减去空白高度后小于或等于当前page的空白高度时，将firstChild移到当前pageInner中，并进行分割
                            $(this).find(S.pageInner).append(firstChild);
                            separate(firstChild, firstChild.height() - (firstChild.outerHeight(true) - overflowH), firstChild.outerHeight(true) - overflowH);
                        };
                    } else { // 其它情况，直接将firstChild移动到当前page中
                        $(this).find(S.pageInner).append(firstChild);
                    };
                } else { // 不为question元素时
                    if (overflowH < firstChild.outerHeight(true)) { // firstChild高度小于overflowH时，直接中断
                        break;
                    } else { // 其它情况，直接将firstChild移动到当前page中
                        $(this).find(S.pageInner).append(firstChild);
                    };
                };

                j++;
                if (j == 20) break;
            };

            if (!$(this).find(S.pageInner).children().size()) { // pageInner为空时，移除page
                $(this).remove();
            };
        });
    };

})();

/*$.fn.iterator = function(callback) {
    for (var i = 0; i < this.length; i++) {
        callback.call(this.get(i), i, this.get(i), this);
    };
};

var flexpages = $('.flex-page');
flexpages.iterator(function(i, item, itself) {
    console.log(i);
    if (i == 1) {
        itself[itself.length] = $('.flex-wrapper')[0];
        itself.length++;
        console.log(flexpages)
    };
});*/
</script>
</body>

</html>
